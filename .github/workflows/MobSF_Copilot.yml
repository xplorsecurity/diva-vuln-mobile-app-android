name: Mobile AppSec – MobSF + CodeQL Autofix

on:
  pull_request:
    branches: [ "master" ]
  push:
    branches: [ "master" ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # -----------------------------
  # CodeQL – Autofix-capable scan
  # -----------------------------
  codeql:
    name: CodeQL Scan (Custom Queries)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: ./Codeql/QueriesMobSF

      - name: Build Android project
        run: ./gradlew assembleDebug --no-daemon

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # -----------------------------
  # MobSF – Discovery scan only
  # -----------------------------
  mobsf:
    name: MobSF Mobile SAST (Discovery)
    runs-on: ubuntu-latest
    needs: codeql

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Zip source code
        run: |
          zip -r app.zip .

      - name: Start MobSF
        run: |
          docker run -d -p 8000:8000 \
            opensecurity/mobile-security-framework-mobsf

      - name: Wait for MobSF
        run: sleep 30

      - name: Upload App to MobSF
        run: |
          curl -X POST http://localhost:8000/api/v1/upload \
            -H "Authorization: ${{ secrets.MOBSF_API_KEY }}" \
            -F "file=@app.zip" \
            -o upload.json

      - name: Extract Scan Hash
        run: |
          echo "SCAN_HASH=$(jq -r .hash upload.json)" >> $GITHUB_ENV

      - name: Run Static Analysis
        run: |
          curl -X POST http://localhost:8000/api/v1/scan \
            -H "Authorization: ${{ secrets.MOBSF_API_KEY }}" \
            -d "scan_type=zip" \
            -d "hash=$SCAN_HASH"

      - name: Download MobSF Report
        run: |
          curl -X POST http://localhost:8000/api/v1/report_json \
            -H "Authorization: ${{ secrets.MOBSF_API_KEY }}" \
            -d "scan_hash=$SCAN_HASH" \
            -o mobsf-report.json
